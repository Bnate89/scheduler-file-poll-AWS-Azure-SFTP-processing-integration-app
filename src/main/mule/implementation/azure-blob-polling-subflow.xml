<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:azure-storage="http://www.mulesoft.org/schema/mule/azure-storage"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/azure-storage http://www.mulesoft.org/schema/mule/azure-storage/current/mule-azure-storage.xsd">

    <!-- ============================================================================ -->
    <!-- Azure Blob Storage Polling Subflow                                           -->
    <!-- ============================================================================ -->
    
    <sub-flow name="azure-blob-polling-subflow">
        <logger level="INFO" doc:name="Log Azure Polling Start"
            message='#["[AZURE_POLL_START] CorrelationId: " ++ vars.correlationId ++ " | Container: " ++ p("azure.storage.containerName") ++ " | Path: " ++ p("azure.storage.inbound.blobPath")]'/>
        
        <set-variable variableName="fileSource" value="AZURE" doc:name="Set File Source"/>
        
        <try doc:name="Azure List Blobs">
            <!-- List blobs in Azure container -->
            <azure-storage:list-blobs-in-container doc:name="List Azure Blobs" 
                config-ref="Azure_Storage_Config" 
                containerName="${azure.storage.containerName}"
                blobPath="${azure.storage.inbound.blobPath}"
                target="azureBlobList"/>
            
            <logger level="INFO" doc:name="Log Blobs Found"
                message='#["[AZURE_BLOBS_FOUND] CorrelationId: " ++ vars.correlationId ++ " | Count: " ++ sizeOf(vars.azureBlobList)]'/>
            
            <!-- Filter supported file formats -->
            <ee:transform doc:name="Filter Supported Files">
                <ee:variables>
                    <ee:set-variable variableName="azureFilesToProcess"><![CDATA[%dw 2.0
output application/java
var supportedFormats = (p('file.supported.formats') splitBy ",") map trim($)
---
vars.azureBlobList filter (blob) -> (
    (blob.contentLength default 0) > 0 and
    supportedFormats contains lower((blob.name splitBy ".")[-1] default "")
)]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            
            <logger level="INFO" doc:name="Log Filtered Files"
                message='#["[AZURE_FILES_FILTERED] CorrelationId: " ++ vars.correlationId ++ " | FilesToProcess: " ++ sizeOf(vars.azureFilesToProcess)]'/>
            
            <!-- Process each blob -->
            <foreach collection="#[vars.azureFilesToProcess]" doc:name="Process Each Azure Blob">
                <try doc:name="Process Single Azure Blob">
                    <!-- Set file metadata -->
                    <ee:transform doc:name="Set File Metadata">
                        <ee:variables>
                            <ee:set-variable variableName="blobName"><![CDATA[%dw 2.0
output application/java
---
payload.name]]></ee:set-variable>
                            <ee:set-variable variableName="fileName"><![CDATA[%dw 2.0
output application/java
---
(payload.name splitBy "/")[-1]]]></ee:set-variable>
                            <ee:set-variable variableName="filePath"><![CDATA[%dw 2.0
output application/java
---
payload.name]]></ee:set-variable>
                            <ee:set-variable variableName="fileSize"><![CDATA[%dw 2.0
output application/java
---
payload.contentLength default 0]]></ee:set-variable>
                            <ee:set-variable variableName="fileExtension"><![CDATA[%dw 2.0
output application/java
---
lower((payload.name splitBy ".")[-1] default "")]]></ee:set-variable>
                            <ee:set-variable variableName="azureETag"><![CDATA[%dw 2.0
output application/java
---
payload.eTag default ""]]></ee:set-variable>
                        </ee:variables>
                    </ee:transform>
                    
                    <!-- Download blob content -->
                    <azure-storage:download-blob doc:name="Download Azure Blob" 
                        config-ref="Azure_Storage_Config">
                        <azure-storage:blob 
                            container="${azure.storage.containerName}" 
                            fileName="#[vars.blobName]"/>
                    </azure-storage:download-blob>
                    
                    <!-- Calculate checksum for idempotency -->
                    <ee:transform doc:name="Calculate Checksum">
                        <ee:variables>
                            <ee:set-variable variableName="fileChecksum"><![CDATA[%dw 2.0
import dw::Crypto
output application/java
---
if (!isEmpty(vars.azureETag))
    vars.azureETag
else
    Crypto::hashWith(payload as Binary, "MD5")]]></ee:set-variable>
                            <ee:set-variable variableName="fileContent"><![CDATA[%dw 2.0
output application/java
---
payload]]></ee:set-variable>
                        </ee:variables>
                    </ee:transform>
                    
                    <!-- Process the file -->
                    <flow-ref name="process-file-orchestration-subflow" doc:name="Process File"/>
                    
                    <error-handler>
                        <on-error-continue type="MULE:DUPLICATE_MESSAGE">
                            <logger level="INFO" doc:name="Log Duplicate Skip"
                                message='#["[AZURE_DUPLICATE] CorrelationId: " ++ vars.correlationId ++ " | Blob: " ++ vars.blobName ++ " | File already processed, skipping"]'/>
                        </on-error-continue>
                        <on-error-continue type="ANY">
                            <logger level="ERROR" doc:name="Log File Error"
                                message='#["[AZURE_FILE_ERROR] CorrelationId: " ++ vars.correlationId ++ " | Blob: " ++ vars.blobName ++ " | Error: " ++ error.description]'/>
                            <set-variable variableName="errorCategory" value="#[error.errorType.identifier]" doc:name="Set Error Category"/>
                            <flow-ref name="move-to-error-directory-subflow" doc:name="Move to Error"/>
                        </on-error-continue>
                    </error-handler>
                </try>
            </foreach>
            
            <error-handler>
                <on-error-continue type="AZURE-STORAGE:CONNECTIVITY">
                    <logger level="WARN" doc:name="Log Container Not Found"
                        message='#["[AZURE_CONTAINER_ERROR] CorrelationId: " ++ vars.correlationId ++ " | Container connectivity issue: " ++ p("azure.storage.containerName")]'/>
                </on-error-continue>
                <on-error-propagate type="ANY">
                    <logger level="ERROR" doc:name="Log Azure Error"
                        message='#["[AZURE_ERROR] CorrelationId: " ++ vars.correlationId ++ " | Error: " ++ error.description]'/>
                </on-error-propagate>
            </error-handler>
        </try>
        
        <logger level="INFO" doc:name="Log Azure Polling End"
            message='#["[AZURE_POLL_END] CorrelationId: " ++ vars.correlationId]'/>
    </sub-flow>

    <!-- ============================================================================ -->
    <!-- Azure Archive File Subflow                                                   -->
    <!-- ============================================================================ -->
    
    <sub-flow name="azure-archive-file-subflow">
        <try doc:name="Azure Archive">
            <ee:transform doc:name="Build Archive Path">
                <ee:variables>
                    <ee:set-variable variableName="archiveBlobName"><![CDATA[%dw 2.0
output application/java
---
p('azure.storage.inbound.archivePath') ++ 
(now() as String {format: "yyyyMMdd"}) ++ "/" ++ 
vars.fileName]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            
            <!-- Copy to archive location -->
            <azure-storage:copy-blob doc:name="Copy to Archive" 
                config-ref="Azure_Storage_Config"
                sourceContainerName="${azure.storage.containerName}"
                sourceBlobName="#[vars.blobName]"
                destinationContainerName="${azure.storage.containerName}"
                destinationBlobName="#[vars.archiveBlobName]"/>
            
            <!-- Delete original -->
            <azure-storage:delete-blob doc:name="Delete Original" 
                config-ref="Azure_Storage_Config">
                <azure-storage:blob 
                    container="${azure.storage.containerName}" 
                    fileName="#[vars.blobName]"/>
            </azure-storage:delete-blob>
            
            <logger level="DEBUG" doc:name="Log Archive Success"
                message='#["[AZURE_ARCHIVED] CorrelationId: " ++ vars.correlationId ++ " | From: " ++ vars.blobName ++ " | To: " ++ vars.archiveBlobName]'/>
            
            <error-handler>
                <on-error-continue type="ANY">
                    <logger level="ERROR" doc:name="Log Archive Error"
                        message='#["[AZURE_ARCHIVE_ERROR] CorrelationId: " ++ vars.correlationId ++ " | Blob: " ++ vars.blobName ++ " | Error: " ++ error.description]'/>
                </on-error-continue>
            </error-handler>
        </try>
    </sub-flow>

    <!-- ============================================================================ -->
    <!-- Azure Move to Error Subflow                                                  -->
    <!-- ============================================================================ -->
    
    <sub-flow name="azure-move-to-error-subflow">
        <try doc:name="Azure Move to Error">
            <ee:transform doc:name="Build Error Path">
                <ee:variables>
                    <ee:set-variable variableName="errorBlobName"><![CDATA[%dw 2.0
output application/java
---
p('azure.storage.inbound.errorPath') ++ 
(now() as String {format: "yyyyMMdd"}) ++ "/" ++ 
vars.fileName]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            
            <!-- Copy to error location -->
            <azure-storage:copy-blob doc:name="Copy to Error" 
                config-ref="Azure_Storage_Config"
                sourceContainerName="${azure.storage.containerName}"
                sourceBlobName="#[vars.blobName]"
                destinationContainerName="${azure.storage.containerName}"
                destinationBlobName="#[vars.errorBlobName]"/>
            
            <!-- Delete original -->
            <azure-storage:delete-blob doc:name="Delete Original" 
                config-ref="Azure_Storage_Config">
                <azure-storage:blob 
                    container="${azure.storage.containerName}" 
                    fileName="#[vars.blobName]"/>
            </azure-storage:delete-blob>
            
            <logger level="DEBUG" doc:name="Log Error Move Success"
                message='#["[AZURE_ERROR_MOVED] CorrelationId: " ++ vars.correlationId ++ " | From: " ++ vars.blobName ++ " | To: " ++ vars.errorBlobName]'/>
            
            <error-handler>
                <on-error-continue type="ANY">
                    <logger level="ERROR" doc:name="Log Error Move Failure"
                        message='#["[AZURE_ERROR_MOVE_FAILED] CorrelationId: " ++ vars.correlationId ++ " | Blob: " ++ vars.blobName ++ " | Error: " ++ error.description]'/>
                </on-error-continue>
            </error-handler>
        </try>
    </sub-flow>

</mule>