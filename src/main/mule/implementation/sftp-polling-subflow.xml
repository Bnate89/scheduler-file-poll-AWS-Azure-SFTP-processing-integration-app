<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd">

    <!-- ============================================================================ -->
    <!-- SFTP Polling Subflow                                                         -->
    <!-- ============================================================================ -->
    
    <sub-flow name="sftp-polling-subflow">
        <logger level="INFO" doc:name="Log SFTP Polling Start"
            message='#["[SFTP_POLL_START] CorrelationId: " ++ vars.correlationId ++ " | Directory: " ++ p("sftp.inbound.directory")]'/>
        
        <set-variable variableName="fileSource" value="SFTP" doc:name="Set File Source"/>
        
        <try doc:name="SFTP List Files">
            <!-- List files in SFTP inbound directory -->
            <sftp:list doc:name="List SFTP Files" 
                config-ref="SFTP_Config" 
                directoryPath="${sftp.inbound.directory}"
                target="sftpFileList"/>
            
            <logger level="INFO" doc:name="Log Files Found"
                message='#["[SFTP_FILES_FOUND] CorrelationId: " ++ vars.correlationId ++ " | Count: " ++ sizeOf(vars.sftpFileList)]'/>
            
            <!-- Filter supported file formats -->
            <ee:transform doc:name="Filter Supported Files">
                <ee:variables>
                    <ee:set-variable variableName="sftpFilesToProcess"><![CDATA[%dw 2.0
output application/java
var supportedFormats = (p('file.supported.formats') splitBy ",") map trim($)
---
vars.sftpFileList filter (file) -> (
    !file.attributes.directory and
    supportedFormats contains lower((file.attributes.fileName splitBy ".")[-1] default "")
)]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            
            <logger level="INFO" doc:name="Log Filtered Files"
                message='#["[SFTP_FILES_FILTERED] CorrelationId: " ++ vars.correlationId ++ " | FilesToProcess: " ++ sizeOf(vars.sftpFilesToProcess)]'/>
            
            <!-- Process each file -->
            <foreach collection="#[vars.sftpFilesToProcess]" doc:name="Process Each SFTP File">
                <try doc:name="Process Single SFTP File">
                    <!-- Set file metadata -->
                    <ee:transform doc:name="Set File Metadata">
                        <ee:variables>
                            <ee:set-variable variableName="fileName"><![CDATA[%dw 2.0
output application/java
---
payload.attributes.fileName]]></ee:set-variable>
                            <ee:set-variable variableName="filePath"><![CDATA[%dw 2.0
output application/java
---
payload.attributes.path]]></ee:set-variable>
                            <ee:set-variable variableName="fileSize"><![CDATA[%dw 2.0
output application/java
---
payload.attributes.size]]></ee:set-variable>
                            <ee:set-variable variableName="fileExtension"><![CDATA[%dw 2.0
output application/java
---
lower((payload.attributes.fileName splitBy ".")[-1] default "")]]></ee:set-variable>
                        </ee:variables>
                    </ee:transform>
                    
                    <!-- Read file content -->
                    <sftp:read doc:name="Read SFTP File" 
                        config-ref="SFTP_Config" 
                        path="#[vars.filePath]"/>
                    
                    <!-- Calculate checksum for idempotency -->
                    <ee:transform doc:name="Calculate Checksum">
                        <ee:variables>
                            <ee:set-variable variableName="fileChecksum"><![CDATA[%dw 2.0
import dw::Crypto
output application/java
---
Crypto::hashWith(payload as Binary, "MD5")]]></ee:set-variable>
                            <ee:set-variable variableName="fileContent"><![CDATA[%dw 2.0
output application/java
---
payload]]></ee:set-variable>
                        </ee:variables>
                    </ee:transform>
                    
                    <!-- Process the file -->
                    <flow-ref name="process-file-orchestration-subflow" doc:name="Process File"/>
                    
                    <error-handler>
                        <on-error-continue type="MULE:DUPLICATE_MESSAGE">
                            <logger level="INFO" doc:name="Log Duplicate Skip"
                                message='#["[SFTP_DUPLICATE] CorrelationId: " ++ vars.correlationId ++ " | FileName: " ++ vars.fileName ++ " | File already processed, skipping"]'/>
                        </on-error-continue>
                        <on-error-continue type="ANY">
                            <logger level="ERROR" doc:name="Log File Error"
                                message='#["[SFTP_FILE_ERROR] CorrelationId: " ++ vars.correlationId ++ " | FileName: " ++ vars.fileName ++ " | Error: " ++ error.description]'/>
                            <set-variable variableName="errorCategory" value="#[error.errorType.identifier]" doc:name="Set Error Category"/>
                            <flow-ref name="move-to-error-directory-subflow" doc:name="Move to Error"/>
                        </on-error-continue>
                    </error-handler>
                </try>
            </foreach>
            
            <error-handler>
                <on-error-continue type="SFTP:ILLEGAL_PATH">
                    <logger level="WARN" doc:name="Log Directory Not Found"
                        message='#["[SFTP_DIR_NOT_FOUND] CorrelationId: " ++ vars.correlationId ++ " | Directory does not exist: " ++ p("sftp.inbound.directory")]'/>
                </on-error-continue>
                <on-error-propagate type="ANY">
                    <logger level="ERROR" doc:name="Log SFTP Error"
                        message='#["[SFTP_ERROR] CorrelationId: " ++ vars.correlationId ++ " | Error: " ++ error.description]'/>
                </on-error-propagate>
            </error-handler>
        </try>
        
        <logger level="INFO" doc:name="Log SFTP Polling End"
            message='#["[SFTP_POLL_END] CorrelationId: " ++ vars.correlationId]'/>
    </sub-flow>

    <!-- ============================================================================ -->
    <!-- SFTP Archive File Subflow                                                    -->
    <!-- ============================================================================ -->
    
    <sub-flow name="sftp-archive-file-subflow">
        <try doc:name="SFTP Archive">
            <ee:transform doc:name="Build Archive Path">
                <ee:variables>
                    <ee:set-variable variableName="archivePath"><![CDATA[%dw 2.0
output application/java
---
p('sftp.inbound.archiveDirectory') ++ "/" ++ 
(now() as String {format: "yyyyMMdd"}) ++ "/" ++ 
vars.fileName]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            
            <sftp:move doc:name="Move to Archive" 
                config-ref="SFTP_Config" 
                sourcePath="#[vars.filePath]" 
                targetPath="#[vars.archivePath]"
                createParentDirectories="true"
                overwrite="true"/>
            
            <logger level="DEBUG" doc:name="Log Archive Success"
                message='#["[SFTP_ARCHIVED] CorrelationId: " ++ vars.correlationId ++ " | From: " ++ vars.filePath ++ " | To: " ++ vars.archivePath]'/>
            
            <error-handler>
                <on-error-continue type="ANY">
                    <logger level="ERROR" doc:name="Log Archive Error"
                        message='#["[SFTP_ARCHIVE_ERROR] CorrelationId: " ++ vars.correlationId ++ " | FileName: " ++ vars.fileName ++ " | Error: " ++ error.description]'/>
                </on-error-continue>
            </error-handler>
        </try>
    </sub-flow>

    <!-- ============================================================================ -->
    <!-- SFTP Move to Error Subflow                                                   -->
    <!-- ============================================================================ -->
    
    <sub-flow name="sftp-move-to-error-subflow">
        <try doc:name="SFTP Move to Error">
            <ee:transform doc:name="Build Error Path">
                <ee:variables>
                    <ee:set-variable variableName="errorPath"><![CDATA[%dw 2.0
output application/java
---
p('sftp.inbound.errorDirectory') ++ "/" ++ 
(now() as String {format: "yyyyMMdd"}) ++ "/" ++ 
vars.fileName]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            
            <sftp:move doc:name="Move to Error" 
                config-ref="SFTP_Config" 
                sourcePath="#[vars.filePath]" 
                targetPath="#[vars.errorPath]"
                createParentDirectories="true"
                overwrite="true"/>
            
            <logger level="DEBUG" doc:name="Log Error Move Success"
                message='#["[SFTP_ERROR_MOVED] CorrelationId: " ++ vars.correlationId ++ " | From: " ++ vars.filePath ++ " | To: " ++ vars.errorPath]'/>
            
            <error-handler>
                <on-error-continue type="ANY">
                    <logger level="ERROR" doc:name="Log Error Move Failure"
                        message='#["[SFTP_ERROR_MOVE_FAILED] CorrelationId: " ++ vars.correlationId ++ " | FileName: " ++ vars.fileName ++ " | Error: " ++ error.description]'/>
                </on-error-continue>
            </error-handler>
        </try>
    </sub-flow>

</mule>